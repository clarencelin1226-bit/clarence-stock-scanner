name: TW Stock Scanner

on:
  workflow_dispatch: {}
  schedule:
    # GitHub Actions 的 cron 是 UTC 時間
    # 台灣時間 14:40 (= UTC 06:40) 週一~週五
    - cron: "40 6 * * 1-5"

jobs:
  run-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run scanner
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          FINMIND_TOKEN: ${{ secrets.FINMIND_TOKEN }}
        run: |
          python scanner.py
          
      - name: Debug files after scanner
        run: |
          echo "=== pwd ==="
          pwd
          echo "=== ls -la ==="
          ls -la
          echo "=== find scanner_result.json ==="
          find . -maxdepth 3 -name "scanner_result.json" -print || true
          echo "=== cat scanner_result.json ==="
          cat scanner_result.json || true

      - name: Dispatch to backtest tracker
        env:
          PAT_BACKTEST: ${{ secrets.PAT_BACKTEST }}
        run: |
          if [ ! -f scanner_result.json ]; then
            echo "scanner_result.json not found, skip tracker dispatch"
            exit 0
          fi

          echo "=== scanner_result.json ==="
          cat scanner_result.json
          echo "==========================="

          python - << 'PY'
          import json, os, subprocess, sys

          with open("scanner_result.json", "r", encoding="utf-8") as f:
              data = json.load(f)

          stocks = data.get("stocks", [])
          signal_date = data.get("signal_date", "")

          if not stocks:
              print("No stocks selected -> skip tracker dispatch")
              sys.exit(0)

          if not signal_date:
              print("Missing signal_date -> skip tracker dispatch")
              sys.exit(0)

          pat = os.environ.get("PAT_BACKTEST")
          if not pat:
              print("Missing PAT_BACKTEST secret")
              sys.exit(1)

          payload = {
              "event_type": "run-tracker",
              "client_payload": {
                  "input_stocks": ",".join(stocks),
                  "signal_date": signal_date
              }
          }

          print("Dispatch payload:", payload)

          cmd = [
              "curl", "-sS", "-X", "POST",
              "-H", f"Authorization: token {pat}",
              "-H", "Accept: application/vnd.github+json",
              "https://api.github.com/repos/clarencelin1226-bit/clarence-stock-backtest/dispatches",
              "-d", json.dumps(payload)
          ]

          subprocess.check_call(cmd)
          print("Tracker dispatch sent successfully.")
          PY
